<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <title>Team workflow for Umbraco Cloud and Azure Devops</title>

    <link rel="stylesheet" href="dist/reset.css" />
    <link rel="stylesheet" href="dist/reveal.css" />
    <link rel="stylesheet" href="dist/theme/dotcontrol.css" />

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" />

    
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section data-transition="convex">
          <h1>Team workflow for Umbraco Cloud</h1>
          <h2>and Azure Devops</h2>
        </section>
        <section>
          <h2>Introduction</h2>
          <ul>
            <li>Dave Woestenborghs</li>
            <li>Work at <a href="https://dotcontrol.com/">DotControl</a></li>
            <li>Umbraco MVP (7x)</li>
            <li>Active community member since 2008</li>
          </ul>
          <aside class="notes">
            Data drive agency with offices in r'dam, heerlen and curacoa<br />
            MVP since 2016<br />
            First blog written in 2008
          </aside>
        </section>
        <section>
          <h2>Today is about</h2>
          <p>Setting up a team workflow for umbraco 9 on cloud</p>
          <p class="fragment">Automating deployments</p>
          <p class="fragment">Using Azure Devops</p>
          <aside class="notes"></aside>
        </section>
		<section>
			<h2>What makes up a Cloud website</h2>
			<p class="fragment">A git repository</p>
			<p class="fragment">Hosting infrastructure</p>
			<aside class="notes">
				- Git repository containing your website code <br>
				- For V7/8 projects this would contain your compiled assemblies / frontend code. No build process <br>
				- For V9 you can now push your C# code and this will be build on each deploy (even between environments) <br>
				- Web server, blob storage, database <br>
			</aside>
		</section>
		<section>
			<h1>Umbraco Cloud Workflow</h2>			
			<aside class="notes">So let's have a look on how the default cloud workflow happens</aside>
		  </section>
        <section>
          <div class="mermaid">
            sequenceDiagram 
				participant Amy 
				participant Cloud9Store 				            	
          </div>
          <aside class="notes">
			  We have amy, our lead developer, working on the Cloud 9 Store website
		  </aside>
        </section>
		<section>			
			<div class="mermaid">
			  sequenceDiagram 
				  participant Amy 
				  participant Cloud9Store 
				  	Cloud9Store->>Amy: Pulls code					          	
			</div>
			<aside class="notes">
				To be able to make changes Amy first need to pull the source code from Umbraco cloud.
			</aside>
		  </section>	
		  <section>			
			<div class="mermaid">
			  sequenceDiagram 
				  participant Amy 
				  participant Cloud9Store 
				  	Cloud9Store->>Amy: Pulls code
				  	Amy->>Amy: Makes changes					             	
			</div>
			<aside class="notes">
				Once cloned and up and running Amy will make her changes on her local development environment
			</aside>
		  </section>
		  <section>			
			<div class="mermaid">
			  sequenceDiagram 
				  participant Amy 
				  participant Cloud9Store 
				  	Cloud9Store->>Amy: Pulls code
				  	Amy->>Amy: Makes changes
				  	Amy->>Cloud9Store: Pushes code            	
			</div>
			<aside class="notes">
				After Amy is happy with her work, she will push the code back to Umbraco cloud.
			</aside>
		  </section>		
		  <section>
			<h1>Behind the scenes</h2>			
			<aside class="notes">
				So let's have a look behind the scenes what happens when amy pushes the code.
			</aside>
		  </section>			
		  
		  <section>			
			<div class="mermaid">
				sequenceDiagram 
					participant Amy			
					participant Cloud9Store		
					participant UmbracoCloud								 
					Amy->>Cloud9Store: Pushes code
					Cloud9Store->>UmbracoCloud : Triggers build
					UmbracoCloud->>UmbracoCloud: Builds code					  
			</div>
			<aside class="notes">
				After Amy pushed her code this will trigger a build process on cloud.
			</aside>
		</section>
			
		<section>			
			<div class="mermaid">
				sequenceDiagram 
					participant Amy		
					participant Cloud9Store			
				  	participant UmbracoCloud				
				  	  Amy->>UmbracoCloud: Pushes code
					  Cloud9Store->>UmbracoCloud : Triggers build
					  UmbracoCloud->>UmbracoCloud: Builds code
					  Note right of UmbracoCloud: dotnet restore
					  Note right of UmbracoCloud: dotnet build
					  Note right of UmbracoCloud: dotnet publish
					  Note right of UmbracoCloud: config transforms					  
			</div>
			<aside class="notes">
				The build process consists of the following steps :
				Restore nuget packages <br>
				Build the solution <br>
				Publish the website <br>
				Apply config transforms <br>

				Note that this will not build any front end code.
			</aside>
		</section>

		<section>
			
			<div class="mermaid">
				sequenceDiagram 
				  participant Amy			
				  participant Cloud9Store			
				  participant UmbracoCloud
				  participant WWWRoot as Website
				  Amy->>UmbracoCloud: Pushes code
				  Cloud9Store->>UmbracoCloud : Triggers build
					  UmbracoCloud->>UmbracoCloud: Builds code
					  Note right of UmbracoCloud: dotnet restore
					  Note right of UmbracoCloud: dotnet build
					  Note right of UmbracoCloud: dotnet publish
					  Note right of UmbracoCloud: config transforms
					  UmbracoCloud->>WWWRoot: Deployment
			</div>
			<aside class="notes">
				After the build process completed succesfully it will deploy the new version to the wwwroot folder.
			</aside>
		</section>

		<section>
			<h2>Who is this suited for ?</h2>
			<p class="fragment">Single developers or small teams.</li>
			<p class="fragment">With great discipline.</p>
		</section>

		<section>
			<h2>Human involvement</h2>
			<p class="fragment">If anything can go wrong, it will.</p>
			<aside class="notes">
				Because we have humans involved we need to factor in Murphy's law.
			</aside>
		</section>

		<section>
			<h2>What could go wrong</h2>
			<p class="fragment">Pushing code that does not compile</p>
			<p class="fragment">Frontend code not updated or in development mode</p>
			<p class="fragment">Referenced a nuget package from internal server</p>
			<p class="fragment">Pushing code that breaks unit tests</p>			

			<aside class="notes">
				- Last minute change and not built locally, but pushed anyway can cause this. <br>
				- Forgot to run the front end build process or ran in development mode. <br>
				- Umbraco cloud can't reach that server, so can't restore it. Or maybe there is authentication needed. <br>
				- We have unit tests in place. Last minute change done without running unit tests and not seeing all the places that are broken. <br>
			</aside>
		</section>

		<section>
			<h2>So what is missing</h2>
			<p class="fragment">A pull request review process</p>
			<p class="fragment">Running unit tests during build process.</p>
			<p class="fragment">Automatic deployment to cloud</p>
			<aside class="notes">				
				- The git repository provided by Umbraco Cloud does not facilitate PR reviews. At DC we have process that requires 2 approvals. In addition we test the build <br>
				- We at DC write a lot of unit tests and we want them to run during build processes. Stopping a release when they fail. <br>
				- After a succesful merge of PR you want to release to cloud automaticly
			</aside>
		</section>

		<section>
			<h1>Azure DevOps to the rescue</h1>
		</section>

		<section>
			<h2>Change in workflow</h2>
			<p class="fragment">Git repository on DevOps will be primary</p>			
		</section>

		<section>
			<h1>Setting up source control</h1>
		</section>
       
        <!-- code example
				<section>
					<h2>Disable preview</h2>
					<pre>
						<code data-trim data-noescape class="language-csharp" data-line-numbers="1|3|10|12-20">
							public class SendingContentNotificationHandler : INotificationHandler<SendingContentNotification>
							{																
								public void Handle(SendingContentNotification notification)
								{
									if (ContentTypes.Contains(notification.Content.ContentTypeAlias))
									{
										return;
									}
							
									notification.Content.AllowPreview = false;
																	
									var urls = new List<UrlInfo>();							
									var urlCultures = notification.Content.Urls.Select(x => x.Culture).Distinct().ToList();
							
									foreach (var culture in urlCultures)
									{
										urls.Add(UrlInfo.Message("This page has no links", culture));
									}
							
									notification.Content.Urls = urls.ToArray();
								}
							}
						</code>
					</pre>
				</section>
				-->

        <section>
          <h2>Thank you</h2>
          <p>☁ ☁ ☁ And have a heavenly day ☁ ☁ ☁</p>
          <p>
            <a href="https://dawoe.github.io/umbraco-make-your-editors-happy/"
              >https://dawoe.github.io/umbraco-make-your-editors-happy/</a
            >
          </p>
        </section>
      </div>
    </div>

    <div id="dc-logo">
      <a href="https://dotcontrol.com/">
        <img src="img/dotcontrol-colored.svg" />
      </a>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script src="plugin/zoom/zoom.js"></script>
    <script src="dist/mermaid.min.js"></script>
    <script>
      // More info about initialization & config:
      // - https://revealjs.com/initialization/
      // - https://revealjs.com/config/
      Reveal.initialize({
        hash: true,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealZoom],
      });


      mermaid.mermaidAPI.initialize({
        startOnLoad: false,		
		sequence: {
			mirrorActors : false,
			useMaxWidth : false,						
		}		
      });

      let doMermaidStuff = function doMermaidStuff(event) {
		  console.log(event)
        let mermaidDivs = event.currentSlide.querySelectorAll(".mermaid");

		let oldContainerDivs = document.querySelectorAll('.mermaidContainer')

		oldContainerDivs.forEach(function(container) {
			container.parentNode.removeChild(container);
		});

        let indices = Reveal.getIndices();
        let pageno = `${indices.h}-${indices.v}`;

        mermaidDivs.forEach(function (mermaidDiv, i) {
		  mermaidDiv.style.display = 'none';
		  let mermaidContainerDiv = document.createElement("div");
		  mermaidContainerDiv.classList.add('mermaidContainer');
		  mermaidDiv.parentNode.appendChild(mermaidContainerDiv);
          let insertSvg = function (svgCode, bindFunctions) {
            mermaidContainerDiv.innerHTML = svgCode;           
          };
          let graphDefinition = mermaidDiv.textContent;
          mermaid.mermaidAPI.render(
            `mermaid${pageno}-${i}`,
            graphDefinition,
            insertSvg
          );
        });
        Reveal.layout();
      };

      //Reveal.on("ready", (event) => doMermaidStuff(event));
      Reveal.on("slidechanged", (event) => doMermaidStuff(event));
    </script>

<style type="text/css">
	.mermaidContainer {
		width: 100%;
		max-width: 100%;
		display: block;
	}

	svg[id^="m"][width][height][viewBox] {
		width: 80%;
		height: auto;
	}

	.actor {
	  stroke: #fff !important;
	  fill: #ff2345 !important;
	}
	text.actor {
	  fill: #fff !important;
	  stroke: none !important;
	  font-family: GalanoGrotesque, Helvetica !important;
	  text-transform: uppercase;
	  font-weight: 700 !important;
	}

	.actor-line {
	  stroke: #fff !important;
	}

	.messageLine0 {
	  stroke-width: 1.5;
	  stroke-dasharray: "2 2";
	  marker-end: "url(#arrowhead)";
	  stroke: #fff !important;
	}

	.messageLine1 {
	  stroke-width: 1.5;
	  stroke-dasharray: "2 2";
	  stroke: #fff !important;
	}

	#arrowhead {
	  fill: #fff !important;
	}

	#arrowhead path{
	  fill: #fff !important;
	  stroke: #fff !important;
	}

	.messageText {
	  fill: #fff !important;
	  stroke: none;
	  font-family: GalanoGrotesque, "trebuchet ms", verdana, arial !important;
	  font-size: 14px;
	  font-weight: 700 !important;
	}

	.labelBox {
	  stroke: #fff;
	  fill: #ff2345 !important;;
	}

	.labelText {
	  fill: #fff !important;
	  stroke: none;
	  font-family: GalanoGrotesque, "trebuchet ms", verdana, arial !important;
	}

	.loopText {
	  fill: #fff !important;
	  stroke: none;
	  font-family: GalanoGrotesque, "trebuchet ms", verdana, arial !important;
	}

	.loopText>tspan {
	  fill: #fff !important;
	  stroke: none;
	  font-family: GalanoGrotesque, "trebuchet ms", verdana, arial !important;
	}

	.loopLine {
	  stroke-width: 2;
	  stroke-dasharray: "2 2";
	  marker-end: "url(#arrowhead)";
	  stroke: #fff !important;
	}

	.note {
	  stroke: #ff2345 !important;
	  fill: #fff !important;
	}

	.noteText>tspan {
	  fill: #ff2345 !important;
	  color:  #ff2345 !important;;
	  stroke: none;
	  font-family: GalanoGrotesque, "trebuchet ms", verdana, arial !important;
	  font-size: 14px;
	}
	
  </style>
  </body>
</html>
